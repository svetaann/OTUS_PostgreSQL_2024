# Физический уровень PostgreSQL
## Домашнее задание
* создайте виртуальную машину c Ubuntu 20.04/22.04 LTS в ЯО/Virtual Box/докере
> ВМ (Ubuntu 22.04.3) была создана с использованием корпоративных ресурсов
* поставьте на нее PostgreSQL 15 через sudo apt
* проверьте что кластер запущен через sudo -u postgres pg_lsclusters
```
ubuntu@mgt-annenkova-test:~$ sudo -u postgres pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
15  main    5433 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log
```
* зайдите из под пользователя postgres в psql и сделайте произвольную таблицу с произвольным содержимым
```
hw3=# create table test(c1 text);
CREATE TABLE
hw3=# insert into test values('1');
INSERT 0 1
```
* остановите postgres например через sudo -u postgres pg_ctlcluster 15 main stop
```
ubuntu@mgt-annenkova-test:~$ sudo -u postgres pg_ctlcluster 15 main stop                     Warning: stopping the cluster using pg_ctlcluster will mark the systemd unit as failed. Consider using systemctl:
  sudo systemctl stop postgresql@15-main
ubuntu@mgt-annenkova-test:~$ sudo -u postgres pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
15  main    5433 down   postgres /var/lib/postgresql/15/main /var/log/postgresql                                                                           /postgresql-15-main.log
```
* создайте новый диск к ВМ размером 10GB

* добавьте свеже-созданный диск к виртуальной машине - надо зайти в режим ее редактирования и дальше выбрать пункт attach existing disk
* проинициализируйте диск согласно инструкции и подмонтировать файловую систему, только не забывайте менять имя диска на актуальное, в вашем случае это скорее всего будет /dev/sdb - https://www.digitalocean.com/community/tutorials/how-to-partition-and-format-storage-devices-in-linux
* перезагрузите инстанс и убедитесь, что диск остается примонтированным (если не так смотрим в сторону fstab)
```
ubuntu@mgt-annenkova-test:~$ sudo parted -l | grep Error
Error: /dev/sdb: unrecognised disk label
ubuntu@mgt-annenkova-test:~$ sudo parted /dev/sdb mklabel gpt
Information: You may need to update /etc/fstab.

ubuntu@mgt-annenkova-test:~$ sudo parted -a opt /dev/sdb mkpart primary ext4 0%                                                                            100%
Information: You may need to update /etc/fstab.
ubuntu@mgt-annenkova-test:~$ sudo mkfs.ext4 -L datapartition /dev/sdb1
mke2fs 1.46.5 (30-Dec-2021)
Creating filesystem with 2620928 4k blocks and 655360 inodes
Filesystem UUID: 606f5767-79ec-4726-bafa-345aafb27e02
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632

Allocating group tables: done
Writing inode tables: done
Creating journal (16384 blocks): done
Writing superblocks and filesystem accounting information: done
ubuntu@mgt-annenkova-test:~$ sudo mkdir -p /mnt/data
ubuntu@mgt-annenkova-test:~$ sudo nano /etc/fstab
ubuntu@mgt-annenkova-test:~$ sudo mount -a
```
> После перезагрузки:
```
ubuntu@mgt-annenkova-test:~$ df -h -x tmpfs
Filesystem                         Size  Used Avail Use% Mounted on
/dev/mapper/ubuntu--vg-ubuntu--lv   14G  8.5G  4.8G  64% /
/dev/sda2                          1.7G  358M  1.3G  23% /boot
/dev/sdb1                          9.8G   24K  9.3G   1% /mnt/data
```
* сделайте пользователя postgres владельцем /mnt/data
* перенесите содержимое /var/lib/postgres/15 в /mnt/data
```
ubuntu@mgt-annenkova-test:~$ sudo chown -R postgres:postgres /mnt/data/
ubuntu@mgt-annenkova-test:~$ sudo mv /var/lib/postgresql/15 /mnt/data
ubuntu@mgt-annenkova-test:~$ ls -l /mnt/data/
total 20
drwxr-xr-x 3 postgres postgres  4096 Dec 24 15:13 15
drwx------ 2 postgres postgres 16384 Dec 24 15:25 lost+found
```
* попытайтесь запустить кластер - sudo -u postgres pg_ctlcluster 15 main start
* напишите получилось или нет и почему
```
ubuntu@mgt-annenkova-test:~$ sudo -u postgres pg_ctlcluster 15 main start
Error: /var/lib/postgresql/15/main is not accessible or does not exist
```
> Не получилось, так как все данные кластера были перенесены без изменения конфига
* задание: найти конфигурационный параметр в файлах раположенных в /etc/postgresql/15/main который надо поменять и поменяйте его
* напишите что и почему поменяли
> Был изменен путь к директории с данными
```
ubuntu@mgt-annenkova-test:~$ sudo -u postgres pg_conftool 15 main set data_directory /mnt/data/15/main
```
* попытайтесь запустить кластер - sudo -u postgres pg_ctlcluster 15 main start
* напишите получилось или нет и почему
```
ubuntu@mgt-annenkova-test:~$ sudo -u postgres pg_ctlcluster 15 main start
Warning: the cluster will not be running as a systemd service. Consider using systemctl:
  sudo systemctl start postgresql@15-main
ubuntu@mgt-annenkova-test:~$ sudo -u postgres pg_lsclusters
Ver Cluster Port Status Owner    Data directory    Log file
15  main    5433 online postgres /mnt/data/15/main /var/log/postgresql/postgresql-15-main.log
```
> Получилось, потому что теперь постгрес видит директорию с данными
* зайдите через через psql и проверьте содержимое ранее созданной таблицы
```
hw3=# \dt
        List of relations
 Schema | Name | Type  |  Owner
--------+------+-------+----------
 public | test | table | postgres
(1 row)

hw3=# select * from test ;
 c1
----
 1
(1 row)
```
### Задание со звездочкой *
Не удаляя существующий инстанс ВМ сделайте новый, поставьте на его PostgreSQL, удалите файлы с данными из /var/lib/postgres, перемонтируйте внешний диск который сделали ранее от первой виртуальной машины ко второй и запустите PostgreSQL на второй машине так чтобы он работал с данными на внешнем диске, расскажите как вы это сделали и что в итоге получилось.
```

```
